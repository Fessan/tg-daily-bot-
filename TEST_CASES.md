# Тест-кейсы для ручного тестирования

## Подготовка к тестированию

### Предварительные требования:
1. Python 3.11+
2. Установлены зависимости: `pip install -r requirements-dev.txt`
3. Создан тестовый Telegram бот через @BotFather
4. Создан файл `.env` с `BOT_TOKEN=ваш_токен`
5. Создан тестовый Telegram чат (группа или супергруппа)
6. Бот добавлен в чат с правами администратора

---

## 1. Модульные тесты (Unit Tests)

### Запуск автоматических тестов:

```bash
# Все тесты
pytest

# Только unit тесты
pytest -m unit

# С покрытием кода
pytest --cov

# Verbose режим
pytest -v

# Конкретный файл
pytest tests/test_utils.py

# Конкретный тест
pytest tests/test_utils.py::TestIsWorkday::test_workday_wednesday
```

### Ожидаемый результат:
- ✅ Все тесты проходят
- ✅ Coverage > 70%
- ✅ Нет ошибок импорта

---

## 2. Интеграционные тесты (Integration Tests)

### Запуск интеграционных тестов:

```bash
# Только integration тесты
pytest -m integration

# С выводом в реальном времени
pytest -m integration -s
```

### Ожидаемый результат:
- ✅ База данных корректно создается
- ✅ Таблицы и индексы на месте
- ✅ CRUD операции работают

---

## 3. Тестирование запуска бота

### TC-001: Запуск бота без .env файла

**Предусловия:** Файл `.env` не существует

**Шаги:**
1. Удалить или переименовать `.env`
2. Запустить `python3 main.py`

**Ожидаемый результат:**
```
ValueError: BOT_TOKEN не найден в .env файле! Создайте .env файл с BOT_TOKEN=ваш_токен
```

**Статус:** ✅ / ❌

---

### TC-002: Запуск бота с корректным токеном

**Предусловия:** Файл `.env` существует с валидным `BOT_TOKEN`

**Шаги:**
1. Создать `.env` с токеном
2. Запустить `python3 main.py`

**Ожидаемый результат:**
```
2025-11-26 12:00:00 - db - INFO - База данных актуальна (версия 1)
2025-11-26 12:00:00 - __main__ - INFO - ✅ Бот успешно запущен! Scheduler работает, жду рассылки...
```

**Статус:** ✅ / ❌

---

### TC-003: Проверка создания базы данных

**Предусловия:** `bot.db` не существует

**Шаги:**
1. Удалить `bot.db` если есть
2. Запустить бота
3. Проверить наличие `bot.db`

**Ожидаемый результат:**
- ✅ Файл `bot.db` создан
- ✅ Размер > 0 байт
- ✅ В логах: "База данных успешно инициализирована"

**Статус:** ✅ / ❌

---

## 4. Тестирование команд администратора

### TC-101: /start - Инициализация бота в чате

**Предусловия:** 
- Бот добавлен в групповой чат
- Вы являетесь админом чата

**Шаги:**
1. Отправить `/start` в чат
2. Проверить ответ бота

**Ожидаемый результат:**
```
Бот успешно активирован! (пока только тест)
```

**Проверки:**
- ✅ Чат добавлен в таблицу `chats`
- ✅ Админы добавлены в `participants`
- ✅ В логах: "Добавлено админов в чат..."

**Статус:** ✅ / ❌

---

### TC-102: /start от не-админа

**Предусловия:** 
- Бот в групповом чате
- Вы НЕ админ чата

**Шаги:**
1. Отправить `/start` от обычного пользователя

**Ожидаемый результат:**
```
Только админ чата может запускать бота.
```

**Статус:** ✅ / ❌

---

### TC-103: /settime - Установка времени рассылки

**Предусловия:** Бот инициализирован в чате

**Шаги:**
1. Отправить `/settime 10:00`
2. Проверить ответ

**Ожидаемый результат:**
```
Время ежедневной рассылки установлено на 10:00.
```

**Проверки:**
- ✅ В БД `chats.daily_time` = "10:00"
- ✅ В логах: "daily_time обновлено на 10:00"
- ✅ Задача запланирована в scheduler

**Статус:** ✅ / ❌

---

### TC-104: /settime с некорректным форматом

**Шаги:**
1. Отправить `/settime 25:00`
2. Отправить `/settime abc`
3. Отправить `/settime`

**Ожидаемый результат:**
```
Некорректный формат. Используй: /settime 10:00
```
или
```
Укажи время в формате HH:MM, например: /settime 10:00
```

**Статус:** ✅ / ❌

---

### TC-105: /testdaily - Тестовая отправка дэйлика

**Предусловия:** Бот инициализирован

**Шаги:**
1. Отправить `/testdaily`

**Ожидаемый результат:**
```
Текстовый дейлик:
1. Что делали?
2. Какие были проблемы?
3. Что планируете делать?
```

**Проверки:**
- ✅ Сообщение отправлено
- ✅ Можно ответить reply
- ✅ В логах: "Тестовый дэйлик отправлен"

**Статус:** ✅ / ❌

---

### TC-106: /exclude - Исключение участника

**Предусловия:** 
- В чате есть активный участник
- Вы знаете его username или user_id

**Шаги:**
1. Отправить `/list_active` (запомнить участника)
2. Отправить `/exclude @username`
3. Отправить `/list_active` снова

**Ожидаемый результат:**
```
Пользователь с user_id XXXXX больше не будет получать напоминания о дэйлике.
```

**Проверки:**
- ✅ Участник исчез из списка активных
- ✅ В БД `participants.active` = False
- ✅ В логах: "Пользователь исключен"

**Статус:** ✅ / ❌

---

### TC-107: /include - Возврат участника

**Предусловия:** Есть неактивный участник

**Шаги:**
1. Отправить `/include @username`
2. Проверить `/list_active`

**Ожидаемый результат:**
```
Пользователь с user_id XXXXX теперь снова в списке активных.
```

**Проверки:**
- ✅ Участник появился в списке активных
- ✅ В БД `participants.active` = True

**Статус:** ✅ / ❌

---

### TC-108: /list_active - Список активных участников

**Шаги:**
1. Отправить `/list_active` в чат

**Ожидаемый результат:**
```
Результат отправил вам в личку!
```

**В ЛС бота:**
```
Активные участники:
— @username1 (123456)
— @username2 (789012)
```

**Проверки:**
- ✅ В чате только уведомление
- ✅ В ЛС полный список
- ✅ Сообщение в чате удаляется через 30 мин

**Статус:** ✅ / ❌

---

### TC-109: /list_all - Все участники со статусами

**Шаги:**
1. Отправить `/list_all` в чат

**Ожидаемый результат в ЛС:**
```
Все участники:
✅ @active_user (123456)
❌ @inactive_user (789012)
```

**Проверки:**
- ✅ Активные помечены ✅
- ✅ Неактивные помечены ❌

**Статус:** ✅ / ❌

---

## 5. Тестирование команд отчетов

### TC-201: /mychats - Список чатов в ЛС

**Предусловия:** У пользователя есть доступ к чатам

**Шаги:**
1. Отправить `/mychats` в ЛС бота

**Ожидаемый результат:**
```
Ваши чаты:
— Test Chat: `-1001234567890`

Для отчёта за сегодня: `/report <chat_id>`
Для другой даты: `/report <chat_id> YYYY-MM-DD`
```

**Статус:** ✅ / ❌

---

### TC-202: /report - Получение отчетов за сегодня

**Предусловия:** Есть отчеты за сегодня

**Шаги:**
1. В чате отправить `/report`

**Ожидаемый результат в ЛС:**
```
Отчёты за 2025-11-26:

@username1:
1. Сделал фичу X
2. Проблем не было
3. Буду делать Y
```

**Статус:** ✅ / ❌

---

### TC-203: /report за конкретную дату

**Шаги:**
1. Отправить `/report 2025-11-25`

**Ожидаемый результат:**
```
Отчёты за 2025-11-25:
...
```
или
```
Нет отчётов за эту дату.
```

**Статус:** ✅ / ❌

---

### TC-204: /report из ЛС с chat_id

**Шаги:**
1. В ЛС отправить `/report -1001234567890`

**Ожидаемый результат:**
- ✅ Отчеты за сегодня для указанного чата
- ✅ Или "Нет отчётов за эту дату"

**Статус:** ✅ / ❌

---

## 6. Тестирование обработки дэйликов

### TC-301: Ответ на дэйлик (новый участник)

**Предусловия:** 
- Отправлен дэйлик (`/testdaily`)
- Пользователь НЕ в базе

**Шаги:**
1. Ответить reply на дэйлик с текстом отчета

**Ожидаемый результат:**
- ✅ Отчет сохранен
- ✅ В логах: "Добавлен новый участник"
- ✅ В БД: запись в `participants` с `active=True`
- ✅ В БД: запись в `daily_reports`

**Статус:** ✅ / ❌

---

### TC-302: Ответ на дэйлик (существующий участник)

**Предусловия:** Участник уже в базе

**Шаги:**
1. Ответить reply на дэйлик

**Ожидаемый результат:**
- ✅ Отчет обновлен/сохранен
- ✅ В логах: "Сохранён отчет от..."

**Статус:** ✅ / ❌

---

### TC-303: Повторный ответ на дэйлик (обновление отчета)

**Шаги:**
1. Ответить на дэйлик: "Первая версия"
2. Ответить снова: "Обновленная версия"

**Ожидаемый результат:**
- ✅ В БД только одна запись (не дублируется)
- ✅ Текст обновлен на "Обновленная версия"
- ✅ `created_at` обновлен

**Статус:** ✅ / ❌

---

### TC-304: Reply НЕ на дэйлик игнорируется

**Шаги:**
1. Написать любое сообщение от бота (не дэйлик)
2. Ответить reply на него

**Ожидаемый результат:**
- ✅ Ответ проигнорирован
- ✅ В БД ничего не сохранилось
- ✅ В логах нет записи о сохранении

**Статус:** ✅ / ❌

---

## 7. Тестирование планировщика

### TC-401: Автоматическая отправка дэйлика по расписанию

**Предусловия:** 
- Установлено время `/settime` на ближайшее (например +2 минуты)
- Бот запущен

**Шаги:**
1. Дождаться указанного времени
2. Проверить чат

**Ожидаемый результат:**
```
Текстовый дейлик:
1. Что делали?
2. Какие были проблемы?
3. Что планируете делать?
```

**Проверки:**
- ✅ Дэйлик отправлен в указанное время (±1 мин)
- ✅ В логах: "Сработала задача для чата"
- ✅ В логах: "Дэйлик отправлен по расписанию"

**Статус:** ✅ / ❌

---

### TC-402: Дэйлик НЕ отправляется в выходные

**Предусловия:** Сегодня суббота или воскресенье

**Шаги:**
1. Установить время на ближайшее
2. Дождаться

**Ожидаемый результат:**
- ✅ Дэйлик НЕ отправлен
- ✅ В логах: "Сегодня выходной или праздник — дэйлик не отправляется."

**Статус:** ✅ / ❌

---

### TC-403: Проверка отчетов через 2 часа

**Предусловия:** 
- Отправлен дэйлик
- Прошло 2 часа
- Есть неотчитавшиеся

**Шаги:**
1. Дождаться 2 часа после дэйлика
2. Проверить чат

**Ожидаемый результат:**
```
@user1 @user2 @user3
Жду Текстовый Дейлик!
```

**Проверки:**
- ✅ Упомянуты только неотчитавшиеся
- ✅ Отчитавшиеся НЕ упомянуты
- ✅ В логах: "Запущена проверка отчетов"

**Статус:** ✅ / ❌

---

### TC-404: Rate limiting при большом количестве упоминаний

**Предусловия:** >50 неотчитавшихся (искусственно в БД)

**Ожидаемый результат:**
- ✅ Упоминания отправлены несколькими сообщениями
- ✅ В каждом сообщении ≤50 упоминаний
- ✅ Между сообщениями пауза ~0.5 сек
- ✅ В логах нет ошибок

**Статус:** ✅ / ❌

---

## 8. Тестирование утилит

### TC-501: is_workday() - рабочий день

**Шаги:**
1. Запустить в рабочий день (пн-пт, не праздник)

**Ожидаемый результат:**
- ✅ `is_workday()` возвращает `True`

**Статус:** ✅ / ❌

---

### TC-502: is_workday() - выходной

**Шаги:**
1. Запустить в выходной (сб-вс)

**Ожидаемый результат:**
- ✅ `is_workday()` возвращает `False`

**Статус:** ✅ / ❌

---

### TC-503: delete_later() - удаление сообщения

**Шаги:**
1. Отправить команду, которая создает временное сообщение
2. Подождать 30 минут

**Ожидаемый результат:**
- ✅ Сообщение удалено через 30 мин

**Статус:** ✅ / ❌

---

## 9. Тестирование общих команд

### TC-601: /help - Справка

**Шаги:**
1. Отправить `/help`

**Ожидаемый результат:**
```
Как работать с Дейлик-Ботом?
...
(полная справка по командам)
```

**Проверки:**
- ✅ Отображаются все команды
- ✅ Есть описания
- ✅ Есть контакт @Fessan

**Статус:** ✅ / ❌

---

## 10. Стресс-тесты

### TC-701: Одновременные команды

**Шаги:**
1. Несколько пользователей одновременно отправляют команды

**Ожидаемый результат:**
- ✅ Все команды обработаны
- ✅ Нет ошибок в логах
- ✅ БД консистентна

**Статус:** ✅ / ❌

---

### TC-702: Большое количество отчетов

**Шаги:**
1. 100+ участников отправляют отчеты

**Ожидаемый результат:**
- ✅ Все отчеты сохранены
- ✅ `/report` работает быстро (<2 сек)
- ✅ Индексы ускоряют запросы

**Статус:** ✅ / ❌

---

## 11. Тестирование логирования

### TC-801: Проверка bot.log

**Шаги:**
1. Выполнить различные команды
2. Проверить файл `bot.log`

**Ожидаемый результат:**
- ✅ Файл создан
- ✅ Записи с timestamp
- ✅ Уровни логирования (INFO, ERROR)
- ✅ Кодировка UTF-8 (кириллица читается)

**Статус:** ✅ / ❌

---

## 12. Тестирование ошибок

### TC-901: Бот кикнут из чата

**Шаги:**
1. Кикнуть бота из чата
2. Попробовать отправить команду в ЛС

**Ожидаемый результат:**
- ✅ Бот не падает
- ✅ Адекватное сообщение об ошибке
- ✅ Ошибка залогирована

**Статус:** ✅ / ❌

---

### TC-902: Нет прав на удаление сообщений

**Предусловия:** Отобрать у бота права на удаление

**Ожидаемый результат:**
- ✅ Бот продолжает работать
- ✅ Ошибка подавлена gracefully
- ✅ В логах: предупреждение

**Статус:** ✅ / ❌

---

## Результаты тестирования

| Категория | Всего тестов | Пройдено | Провалено | % успеха |
|-----------|--------------|----------|-----------|----------|
| Запуск | 3 | | | |
| Админ команды | 9 | | | |
| Отчеты | 4 | | | |
| Дэйлики | 4 | | | |
| Планировщик | 4 | | | |
| Утилиты | 3 | | | |
| Общие | 1 | | | |
| Стресс | 2 | | | |
| Логирование | 1 | | | |
| Ошибки | 2 | | | |
| **ИТОГО** | **33** | | | |

---

## Критичные баги (если найдены)

### Bug #1: Описание
**Серьезность:** Critical / High / Medium / Low  
**Шаги воспроизведения:**  
**Ожидаемый результат:**  
**Фактический результат:**  
**Статус:** Open / Fixed

---

## Заметки тестировщика

(Любые дополнительные наблюдения, предложения по улучшению)

---

**Дата тестирования:** _____________  
**Тестировщик:** _____________  
**Версия:** 2.0 (Модульная архитектура)  
**Commit:** de7ba99

