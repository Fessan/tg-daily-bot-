# Архитектура Telegram Daily Bot

## Структура проекта

```
tg-daily-bot/
├── main.py                 # Точка входа - только инициализация и запуск (77 строк)
├── config.py               # Конфигурация и константы (44 строки)
├── bot_instance.py         # Глобальные объекты (bot, dp, scheduler) (22 строки)
├── utils.py                # Вспомогательные функции (40 строк)
├── scheduler_tasks.py      # Планировщик и отправка дэйликов (157 строк)
├── db.py                   # Работа с базой данных (130 строк)
├── handlers/               # Модуль обработчиков команд
│   ├── __init__.py         # Регистрация всех handlers (14 строк)
│   ├── admin.py            # Команды администраторов (371 строка)
│   ├── reports.py          # Команды отчетов (126 строк)
│   ├── common.py           # Общие команды (help) (40 строк)
│   └── daily.py            # Обработка ответов на дэйлики (100 строк)
├── requirements.txt        # Зависимости проекта
├── .env                    # Конфигурация (BOT_TOKEN)
├── .gitignore              # Исключения для Git
├── bot.db                  # База данных SQLite (создается автоматически)
├── bot.log                 # Лог-файл (создается автоматически)
├── README.md               # Документация для пользователей
├── ARCHITECTURE.md         # Техническая документация (этот файл)
└── CHANGELOG.md            # История изменений
```

**Всего кода: 1121 строка** (вместо 758 строк в одном файле)

## Описание модулей

### main.py (77 строк)
**Назначение:** Точка входа в приложение.  
**Содержит:**
- Настройку логирования
- Функцию `main()` с инициализацией
- Импорт всех handlers
- Запуск polling

**Не содержит:** Бизнес-логику - она вынесена в специализированные модули.

### config.py (44 строки)
**Назначение:** Централизованное хранение всех настроек.  
**Содержит:**
- Загрузку `.env` и проверку `BOT_TOKEN`
- Все константы (интервалы, лимиты, тексты)
- Настройки логирования
- Часовой пояс

**Преимущества:** Все настройки в одном месте, легко изменить конфигурацию.

### bot_instance.py (22 строки)
**Назначение:** Глобальные объекты для избежания циклических импортов.  
**Содержит:**
- Экземпляры `bot`, `dp`, `scheduler`
- Переменную `loop` и функцию `set_event_loop()`

**Зачем:** Все модули импортируют эти объекты из одного места.

### utils.py (40 строк)
**Назначение:** Вспомогательные функции общего назначения.  
**Содержит:**
- `is_workday()` - проверка рабочего дня
- `delete_later()` - отложенное удаление сообщений

**Может расширяться:** Другие утилиты (форматирование, валидация и т.д.)

### scheduler_tasks.py (157 строк)
**Назначение:** Вся логика планирования и автоматической отправки дэйликов.  
**Содержит:**
- `schedule_all_dailies()` - планирование задач для всех чатов
- `send_scheduled_daily()` - отправка дэйлика по расписанию
- `check_daily_reports()` - проверка отчетов и напоминания

**Ответственность:** Работа с scheduler, rate limiting, взаимодействие с БД для проверки отчетов.

### db.py (130 строк)
**Назначение:** Работа с базой данных.  
**Содержит:**
- `init_db()` - создание таблиц, индексов, версионирование
- `ensure_admins_in_db()` - синхронизация админов

**Ответственность:** Вся работа со структурой БД, миграции.

### handlers/ - Модуль обработчиков (651 строка)

#### handlers/__init__.py (14 строк)
**Назначение:** Регистрация всех обработчиков.  
**Содержит:** Импорты всех модулей handlers.

#### handlers/admin.py (371 строка)
**Назначение:** Команды для администраторов чата.  
**Содержит 7 команд:**
- `/start` - инициализация бота в чате
- `/settime` - установка времени рассылки
- `/testdaily` - тестовая отправка дэйлика
- `/exclude` - исключение участника
- `/include` - возврат участника
- `/list_active` - список активных
- `/list_all` - полный список участников

#### handlers/reports.py (126 строк)
**Назначение:** Работа с отчетами.  
**Содержит 2 команды:**
- `/mychats` - список чатов пользователя
- `/report` - получение отчетов за дату

#### handlers/common.py (40 строк)
**Назначение:** Общие команды для всех пользователей.  
**Содержит:**
- `/help` - справка по командам

#### handlers/daily.py (100 строк)
**Назначение:** Обработка ответов на дэйлики.  
**Содержит:**
- `handle_reply()` - универсальный обработчик reply
- Логика добавления участников
- Сохранение отчетов в БД

## Архитектурные решения

### 1. База данных (SQLite)

**Таблицы:**

- **chats** - информация о подключенных чатах
  - `chat_id` (PK) - ID чата Telegram
  - `chat_title` - название чата
  - `daily_time` - время рассылки дэйлика (формат HH:MM)

- **participants** - участники чатов
  - `(chat_id, user_id)` (PK) - составной первичный ключ
  - `username` - имя пользователя
  - `active` - флаг активности (получает ли напоминания)
  - `is_admin` - флаг администратора

- **daily_reports** - сохраненные отчеты
  - `(chat_id, user_id, date)` (PK) - уникальность по чату/пользователю/дате
  - `reply_to_message_id` - ID сообщения дэйлика
  - `message_id` - ID сообщения пользователя
  - `text` - текст отчета
  - `created_at` - время создания

- **schema_version** - версионирование структуры БД
  - `version` (PK) - номер версии
  - `applied_at` - время применения

**Индексы:**
- `idx_daily_reports_date` - поиск по (chat_id, date)
- `idx_participants_active` - поиск по (chat_id, active)
- `idx_participants_username` - поиск по (chat_id, username)

### 2. Scheduler (APScheduler)

Используется `AsyncIOScheduler` для планирования:
- Ежедневная отправка дэйликов по расписанию (cron jobs)
- Отложенная проверка отчетов через N часов (one-time jobs)

**Важно:** 
- Scheduler работает в отдельном потоке
- Используется `asyncio.run_coroutine_threadsafe()` для безопасного вызова async функций
- При изменении времени рассылки все задачи пересоздаются

### 3. Логирование

**Конфигурация:**
- Уровень: INFO
- Формат: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`
- Handlers: 
  - FileHandler → `bot.log` (с кодировкой UTF-8)
  - StreamHandler → консоль

**Что логируется:**
- Запуск/остановка бота
- Создание/изменение расписаний
- Отправка дэйликов
- Сохранение отчетов
- Все ошибки с traceback

### 4. Timezone Management

Все операции используют московское время (`Europe/Moscow`):
- Расписание отправки дэйликов
- Проверка рабочих дней
- Сохранение дат отчетов

Это обеспечивает консистентность независимо от часового пояса сервера.

### 5. Rate Limiting

При отправке напоминаний:
- Упоминания группируются по `MAX_MENTIONS_PER_MESSAGE` (50 по умолчанию)
- Между батчами задержка 0.5 секунды
- Защита от блокировки Telegram API (лимит 30 сообщений/сек)

### 6. Обработка ошибок

**Глобальный уровень:**
```python
try:
    # Инициализация и работа
except KeyboardInterrupt:
    # Graceful shutdown
finally:
    # Закрытие ресурсов (scheduler, bot session)
```

**Локальный уровень:**
- Все критичные операции обернуты в try-except
- Ошибки логируются с полным traceback
- Пользователю показываются понятные сообщения

## Константы конфигурации

Все настраиваемые параметры вынесены в начало `main.py`:

```python
DAILY_CHECK_INTERVAL_HOURS = 2      # Проверка отчетов
CLEANUP_MESSAGE_SECONDS = 1800      # Удаление служебных сообщений
MAX_MENTIONS_PER_MESSAGE = 50       # Rate limiting
DAILY_TEXT = "..."                   # Текст дэйлика
```

## Flow диаграммы

### Отправка дэйлика

```
Scheduler (cron) → send_scheduled_daily()
    ↓
Проверка is_workday()
    ↓
Отправка DAILY_TEXT в чат
    ↓
Планирование check_daily_reports() 
через DAILY_CHECK_INTERVAL_HOURS
```

### Проверка отчетов

```
check_daily_reports()
    ↓
Получить активных участников из БД
    ↓
Получить список отчитавшихся
    ↓
Найти неотчитавшихся
    ↓
Группировка по MAX_MENTIONS_PER_MESSAGE
    ↓
Отправка батчами с задержкой
```

### Сохранение отчета

```
Пользователь отвечает reply на дэйлик
    ↓
Проверка: reply на сообщение бота?
    ↓
Проверка: текст содержит "дейлик"?
    ↓
Добавление/обновление в participants
    ↓
INSERT/UPDATE в daily_reports
    ↓
Логирование
```

## Безопасность

1. **Токен бота** - только в `.env`, файл в `.gitignore`
2. **База данных** - в `.gitignore`, не попадает в Git
3. **Логи** - в `.gitignore`, могут содержать user_id
4. **HTML escaping** - при упоминании пользователей
5. **Валидация** - проверка прав админа перед критичными операциями

## Масштабирование

**Текущие ограничения:**
- Один процесс
- SQLite (не подходит для >1000 одновременных записей)
- In-memory scheduler (теряется при рестарте)

**Для масштабирования:**
- Перейти на PostgreSQL
- Использовать Redis для scheduler state
- Горизонтальное масштабирование через очереди (Celery/RabbitMQ)
- Добавить connection pooling

## Мониторинг и отладка

1. **Логи**: `tail -f bot.log`
2. **База данных**: `sqlite3 bot.db`
3. **Scheduler jobs**: логируются при создании/выполнении
4. **Ошибки**: полный traceback в `bot.log`

## Deployment

### Systemd Service

```ini
[Unit]
Description=Telegram Daily Bot
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/tg-daily-bot
ExecStart=/path/to/venv/bin/python main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### Docker (опционально)

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "main.py"]
```

## Версионирование

Текущая версия схемы БД: **1**

При изменении структуры таблиц:
1. Увеличить `DB_VERSION` в `db.py`
2. Добавить миграционный код в `init_db()`
3. Обновить `ARCHITECTURE.md`

---

**Автор:** [@Fessan](https://t.me/Fessan)  
**Последнее обновление:** 2025-11-26

